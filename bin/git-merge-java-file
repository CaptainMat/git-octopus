#!/bin/bash

LF='
'

MERGE_FAILED=0

git merge-one-file "$1" "$2" "$3" "$4" "$5" "$6" "$7" || MERGE_FAILED=1

READING_CONFLICT=0
case "$MERGE_FAILED" in
1)
	
	tmpFile=

    intentMergeLines=

	while IFS='' read -r line ; do
    	
    	echo "$line" | grep '^<<<<<<<' 1> /dev/null && READING_CONFLICT=1

    	if [ $READING_CONFLICT -eq 1 ]; then
    		RESOLVABLE_LINE=0
    		echo "$line" | grep -e '^import' -e '^ *$' 1> /dev/null && tmpFile+="$line$LF" && RESOLVABLE_LINE=1
            echo "$line" | grep -e 'intent-merge:' 1> /dev/null && intentMergeLines+="`echo "$line" | awk -F":" '{print $NF,$0}'`$LF" && RESOLVABLE_LINE=1
    		echo "$line" | grep -e '^<<<<<<<' -e '^=======' -e '^>>>>>>>' 1> /dev/null && RESOLVABLE_LINE=1

    		if [ $RESOLVABLE_LINE -eq 0 ] ; then
    			exit 1
    		fi
    	else
            if [[ $intentMergeLines ]] ; then
                tmpFile+=`"$intentMergeLines" | sort -n | cut -f2- -d " "`"$LF"
                intentMergeLines=
            fi
            
            tmpFile+="$line$LF"
            
    	fi
		
		echo "$line" | grep '^>>>>>>>' 1> /dev/null && READING_CONFLICT=0
	done < $4
	
	echo $tmpFile > $4
	git update-index --add -- $4

	echo "Java merge succeded on $4"
esac
